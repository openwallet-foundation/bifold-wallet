import { getCredentialName, parsedCredDefName, parsedCredDefNameFromCredential } from '../../src/utils/cred-def'
import { AnonCredsCredentialMetadataKey } from '@credo-ts/anoncreds'

const mockSchemaId = 'did:webvh:QmXysm9EF3kPH4fdCWf48YqCzREgiAe5nFXG3RCXaCShFX:id.test-suite.app:credo:01/resources/zQmSmhgCkiknv5HpLWiiNjgcurgQvwhUqiu8MSGMDVJt3xK'
const mockCredDefId = 'did:webvh:QmXysm9EF3kPH4fdCWf48YqCzREgiAe5nFXG3RCXaCShFX:id.test-suite.app:credo:01/resources/zQmedeFDzpfN3o3vmWBKWygVYg4uB74qwYPhU3TNW1bh1uq'

const mockSchemaResource = {
  '@context': ['https://opsecid.github.io/attested-resource/v1', 'https://w3id.org/security/data-integrity/v2'],
  type: ['AttestedResource'],
  id: 'did:webvh:QmXysm9EF3kPH4fdCWf48YqCzREgiAe5nFXG3RCXaCShFX:id.test-suite.app:credo:01/resources/zQmSmhgCkiknv5HpLWiiNjgcurgQvwhUqiu8MSGMDVJt3xK',
  content: {
    issuerId: 'did:webvh:QmXysm9EF3kPH4fdCWf48YqCzREgiAe5nFXG3RCXaCShFX:id.test-suite.app:credo:01',
    attrNames: ['firstName'],
    name: 'CredoTest',
    version: '1.0',
  },
  metadata: {
    resourceId: 'zQmSmhgCkiknv5HpLWiiNjgcurgQvwhUqiu8MSGMDVJt3xK',
    resourceType: 'anonCredsSchema',
    resourceName: 'CredoTest',
  },
  proof: {
    type: 'DataIntegrityProof',
    cryptosuite: 'eddsa-jcs-2022',
    proofPurpose: 'assertionMethod',
    proofValue: 'z7T11v6ebMHtvhkgpeZRkjQcbMTPmeTBYS7VMCydX2XUN8ygV44xHDckNpf4P9kczTFJHA9g3UzEGcJ2cQsD7Y3B',
    verificationMethod:
      'did:webvh:QmXysm9EF3kPH4fdCWf48YqCzREgiAe5nFXG3RCXaCShFX:id.test-suite.app:credo:01#z6MkukEa8GPVCEPy7EzRSbeHPXD1vsuPy3eD13CkDKQsoCGS',
  },
}

const mockCredDefResource = {
  '@context': ['https://opsecid.github.io/attested-resource/v1', 'https://w3id.org/security/data-integrity/v2'],
  type: ['AttestedResource'],
  id: 'did:webvh:QmXysm9EF3kPH4fdCWf48YqCzREgiAe5nFXG3RCXaCShFX:id.test-suite.app:credo:01/resources/zQmedeFDzpfN3o3vmWBKWygVYg4uB74qwYPhU3TNW1bh1uq',
  content: {
    issuerId: 'did:webvh:QmXysm9EF3kPH4fdCWf48YqCzREgiAe5nFXG3RCXaCShFX:id.test-suite.app:credo:01',
    schemaId:
      'did:webvh:QmXysm9EF3kPH4fdCWf48YqCzREgiAe5nFXG3RCXaCShFX:id.test-suite.app:credo:01/resources/zQmSmhgCkiknv5HpLWiiNjgcurgQvwhUqiu8MSGMDVJt3xK',
    type: 'CL',
    tag: 'default',
    value: {
      primary: {
        n: '77464545684361528330364957623092663167419455977141104893256897946633388423677303019836966108674384150468802341643771837868809245318544433339782200114224628070660027839195175875851812188899183754460294701002514777873619009088598175630775120968307842104665861688087630215239463295934997755119530549761334794446934192711747069556821065805178732933982001874230303287567643559358718408482489109163941699916029946808393512679667571445849145110317321006713156178691377764264305113376427075910343676667506923702564762044688210627425145521555413103846051964527095699380529570238710510834268783407549502870003961068237576071041',
        s: '77338986474861773981179493553769526163102505341095613979296131121783594526631479762755327996980615542538078250899012362412668339950050309492717926725790082856491810066881238888707948577936283890406306160084116214040293911079180197563496863973699768869724595313074279956738920369587984935181149486189842638125230131467841010840573621758823533408941570671565676736018790159356382014712273302313671995211896524892489902731255308535645544695337073313173388202300431954504914831666138145349642963627129883574642880364718226517376248945015647524456387693678344175365422980186357644874137880369774557056537266647211596046089',
        r: {
          firstname:
            '7100709092243461735252404132654892163916323879075120711334804979083609789441889393061324630312210120896590173483838883127373140893678624419220471569473363534673254747515406332536172842447887201510111656949457462381786338324183280556713448321749219876797760723436916830562596872792151738872898967583237792293409201770219226140561631761892304099516335688808161501925083689266684916788637963058901191315630682108030848073392795864764275529851262720463273385995043212630262469063263595005037832005491674528924076059864469888358915553937481270079670120960980973405794967956119669869536597973519595550418712779452338725440',
          master_secret:
            '61620530439077869337685000490441766048417720409096781435830327833688444602884979692345613255814001732297522274424939650492996030193709277440151791754479716366567816991671426145762230330863993580037763584524959177467557470697459814384883817459223916709811975556633178602168192778421111715618369247573211336242628920233333559520538282405624263575727375464727364260202972206594122724034919883171115227248199776575438899056624854713420850201914577084845955246434927976316933995636615222057644237389523665167547039724494223238818080756265015031554087235867103993308219825417502671172918513144011959648659218251054037619222',
        },
        rctxt:
          '75657572143292824375266223705136168586573296004682989744747841953632651428693206162553621180178391710985466994758465941573941438192217876127452911704724512499346526680273387758067392957018576798361649088619809179819095380799298270138639086705868746912051188963051326881292737534481398704257598641379195417603040237617697429677991582816129449280365871031319406341120401591820583747263621345627945684515515174489365872893666418192108454734991604901971869307472802913284057853651025585790308890688908617369083632872678720126091441833122790620454598661451321405585651572830471949290381076333492403878423745881012079516362',
        z: '19133192053771555123179412005151883987981944504102558323314317688969532068481386699155654706767348289660337039931127003738337252379610618147805176711263954782832629110759420384575147611021014098284993447168765602427476563206593951912491266600428048210582815222254868247323786358366844104075722734548938440528935844957282857495632220306485386801788961583967368101800632822660055596406760095796124597258435012468080951366995484721896389181841127041010252848862252605777108974365291840360792080842107224129944351601796006752823408527068032268254483979288582174736943601594604645527853922524680649786503579665279732643722',
      },
      revocation: {
        g: '1 2324023E3DD88B87E477783B7C4DD215039BA19D503F418AB67B3B4B4B468030 1 192F7C10B13B31B8F864DC6325E4E397D5DB7D276E9E1E3826725E5E68F90D8B 2 095E45DDF417D05FB10933FFC63D474548B7FFFF7888802F07FFFFFF7D07A8A8',
        g_dash:
          '1 0371E3F9BEE1661D7349714BAA657EC55E9CF3F3723F36F6A04E9005620333CC 1 1F864855A9823A309C44D0280B0F0D564762FADA7306AA33D37B5DC3DF0FFC1E 1 0049D214B8C992E2BF15A058737F6F561217B362BB75C6FFE0B99C7C67852673 1 21413AFA00CC679ADF1BEFD2AD1FC8BBE09446A99BA339BBF977D689FF7B11B3 2 095E45DDF417D05FB10933FFC63D474548B7FFFF7888802F07FFFFFF7D07A8A8 1 0000000000000000000000000000000000000000000000000000000000000000',
        h: '1 1AAD8D8A64DEF3895DE8925D480B516F9ACC1DFD4A9233871A3C8D1303BB9966 1 0E34AA8CAB39298A82F15853FA87DC15FA5294796F11E8433A89EE9382610ADE 2 095E45DDF417D05FB10933FFC63D474548B7FFFF7888802F07FFFFFF7D07A8A8',
        h0: '1 0133C2F5FD127733FBFFAC6822351C04895CA3F14FC1C4892DD6FC26108017E7 1 153B0321294795EAAB46665FC5D086065F19DDFDB659188CB1994E5A914AC92D 2 095E45DDF417D05FB10933FFC63D474548B7FFFF7888802F07FFFFFF7D07A8A8',
        h1: '1 0A5BC144608DC78EC465EDCE6F3AEA793DD18B154113B154E30C0BD360CABE3F 1 15A16DB75FE897B7355270B9D3DB5EF150DE846A092BF4C01415EDB2D1A4CD59 2 095E45DDF417D05FB10933FFC63D474548B7FFFF7888802F07FFFFFF7D07A8A8',
        h2: '1 15A4D5820083F9DC312247D82794CBC128AC4E9B482731CCCA02BA859F0184BC 1 020B20C06821DBBBDF257E343C7D46832DEF13D5C537A1063F269F71A871D267 2 095E45DDF417D05FB10933FFC63D474548B7FFFF7888802F07FFFFFF7D07A8A8',
        htilde:
          '1 13A4C6E47740CF9256A4147ACBAA8B73A0FADD7670BA97425527EE6E506E5530 1 17960EC3913957929E00ADDC772E4398E24306935C21271A9D555C4FE2C5F36E 2 095E45DDF417D05FB10933FFC63D474548B7FFFF7888802F07FFFFFF7D07A8A8',
        h_cap:
          '1 096BD5F09AC23B2ACCE24377ED1F00DEC48E6B3DFB7165BF2BEC1103520815DE 1 03135F00712BB696F85B3063D6A875C02A245FCFA80AD0223DD4DC8DBA432BEA 1 1BB3A78CD42225C359301E59023D218BBA633D4055546B96541486112FCC957C 1 04BBF53957C44F83D70A2D56B17F21B63E9A2FB91BFAAEDFCC6C1346289DA18D 2 095E45DDF417D05FB10933FFC63D474548B7FFFF7888802F07FFFFFF7D07A8A8 1 0000000000000000000000000000000000000000000000000000000000000000',
        u: '1 124A4148FE138FFE01B852DA3298C79FF38C473F09A7D2B8AFA8A049D893D915 1 06ADFA416EF22E1A2A90164D88924194AB0EB7C8F980AAB78DDFC65927AD1791 1 1882BAC49BC3A6123560D5964F67CC313F91FF02227F8F3010DA8C3A6E58CF07 1 124E7332F0E01042892604605F7F94CF7C94857F05B7B6BED10BB413B35175AD 2 095E45DDF417D05FB10933FFC63D474548B7FFFF7888802F07FFFFFF7D07A8A8 1 0000000000000000000000000000000000000000000000000000000000000000',
        pk: '1 204D79896BCD1925DB403F53EC90A7CCF4380A26637E203F787F337838CB9A08 1 00437754BEA7CAAE8996097B4A08AB0FB583DE683FA443CF58ACFBFC3BD3F80C 2 095E45DDF417D05FB10933FFC63D474548B7FFFF7888802F07FFFFFF7D07A8A8',
        y: '1 045AD7B1D3AEE1BF46364B9A9170A41DFF61C084A59B086072CDE4B3724A7150 1 05113670BB94568AFD4559C67AE7F172CDA694866F4D3C69E62DB926A7C0A8AB 1 0205B4B342AE1AB5EF1D9F79BA025140734B8465F649F205D3918B5896B5A032 1 21F0E05F23C085F5B7766EDEEB9396E7B8D36CF1C2F801DF39C31B28357A8391 2 095E45DDF417D05FB10933FFC63D474548B7FFFF7888802F07FFFFFF7D07A8A8 1 0000000000000000000000000000000000000000000000000000000000000000',
      },
    },
  },
  metadata: {
    resourceId: 'zQmedeFDzpfN3o3vmWBKWygVYg4uB74qwYPhU3TNW1bh1uq',
    resourceType: 'anonCredsCredDef',
    resourceName: 'default',
  },
  proof: {
    type: 'DataIntegrityProof',
    cryptosuite: 'eddsa-jcs-2022',
    proofPurpose: 'assertionMethod',
    proofValue: 'z237iFL6DctCx5LfjmzpZZM41F5pFLFALZrCViZH7Q2BmU6xbKD6MVufCXFGJEsW6UTL4wHYepAPTHzasAvpasNEb',
    verificationMethod:
      'did:webvh:QmXysm9EF3kPH4fdCWf48YqCzREgiAe5nFXG3RCXaCShFX:id.test-suite.app:credo:01#z6MkukEa8GPVCEPy7EzRSbeHPXD1vsuPy3eD13CkDKQsoCGS',
  },
}



describe('Cred Def Utils', () => {
  test('The correct schema name is returned for a webvh cred def id with tag default', async () => {
    const agent: any = {
      context: {},
      modules: {
        anoncreds: {
          getCredentialDefinition: jest.fn().mockResolvedValue({credentialDefinition: mockCredDefResource.content}),
          getSchema: jest.fn().mockResolvedValue({schema: mockSchemaResource.content}),
        },
      },
    }
    const credDefName = await getCredentialName(mockCredDefId, mockSchemaId, agent)
    expect(credDefName).toBe('CredoTest')
  })

  test('The correct cred def tag is returned for a webvh cred def id with tag non-default', async () => {
    const agent: any = {
      context: {},
      modules: {
        anoncreds: {
          getCredentialDefinition: jest.fn().mockResolvedValue({ credentialDefinition: { ...mockCredDefResource.content, tag: 'non-default' } }),
          getSchema: jest.fn().mockResolvedValue({schema: mockSchemaResource.content}),
        },
      },
    }
    const credDefName = await getCredentialName(mockCredDefId, mockSchemaId, agent)
    expect(credDefName).toBe('non-default')
  })

  test('Returns default name for webvh when agent lacks anoncreds module', async () => {
    const agent: any = {
      context: {},
      modules: {},
    }
    const credDefName = await getCredentialName(mockCredDefId, mockSchemaId, agent)
    expect(credDefName).toBe('Credential')
  })

  test('Falls back to schema when webvh cred def fetch fails', async () => {
    const agent: any = {
      context: {},
      modules: {
        anoncreds: {
          getCredentialDefinition: jest.fn().mockRejectedValue(new Error('not found')),
          getSchema: jest.fn().mockResolvedValue({schema: mockSchemaResource.content}),
        },
      },
      config: { logger: { info: jest.fn() } },
    }
    const credDefName = await getCredentialName(mockCredDefId, mockSchemaId, agent)
    expect(credDefName).toBe('CredoTest')
  })

  test('Returns default when both webvh cred def and schema fetch fail', async () => {
    const agent: any = {
      context: {},
      modules: {
        anoncreds: {
          getCredentialDefinition: jest.fn().mockRejectedValue(new Error('not found')),
          getSchema: jest.fn().mockRejectedValue(new Error('not found')),
        },
      },
      config: { logger: { info: jest.fn() } },
    }
    const credDefName = await getCredentialName(mockCredDefId, mockSchemaId, agent)
    expect(credDefName).toBe('Credential')
  })

  test('Returns cred def tag when webvh cred def is non-default and schemaId not used', async () => {
    const agent: any = {
      context: {},
      modules: {
        anoncreds: {
          getCredentialDefinition: jest.fn().mockResolvedValue({ credentialDefinition: { ...mockCredDefResource.content, tag: 'default' } }),
          getSchema: jest.fn().mockResolvedValue({schema: mockSchemaResource.content}),
        },
      },
    }
    const credDefName = await getCredentialName(mockCredDefId, undefined, agent)
    expect(credDefName).toBe('default')
  })

  test('Indy: returns tag when cred def tag is non-default', async () => {
    const indyCredDefId = 'WgWxqztrNooG92RXvxSTWv:3:CL:20:custom'
    const indySchemaId = 'WgWxqztrNooG92RXvxSTWv:2:BankingCredential:1.0'
    const credDefName = await getCredentialName(indyCredDefId, indySchemaId)
    expect(credDefName).toBe('custom')
  })

  test('Indy: returns schema name when cred def tag is default', async () => {
    const indyCredDefId = 'WgWxqztrNooG92RXvxSTWv:3:CL:20:default'
    const indySchemaId = 'WgWxqztrNooG92RXvxSTWv:2:BankingCredential:1.0'
    const credDefName = await getCredentialName(indyCredDefId, indySchemaId)
    expect(credDefName).toBe('BankingCredential')
  })

  test('Indy: returns schema name when no cred def id provided', async () => {
    const indySchemaId = 'Th7MpTaRZVRYnPiabds81Y:2:employment_history:2.0'
    const credDefName = await getCredentialName(undefined, indySchemaId)
    expect(credDefName).toBe('employment_history')
  })

  test('Indy: returns default when neither cred def id nor schema id provided', async () => {
    const credDefName = await getCredentialName(undefined, undefined)
    expect(credDefName).toBe('Credential')
  })

  test('parsedCredDefNameFromCredential uses metadata ids to resolve name', async () => {
    const indyCredDefId = 'WgWxqztrNooG92RXvxSTWv:3:CL:20:default'
    const indySchemaId = 'WgWxqztrNooG92RXvxSTWv:2:BankingCredential:1.0'
    const credential: any = {
      metadata: {
        get: (key: string) => {
          if (key === AnonCredsCredentialMetadataKey) {
            return { credentialDefinitionId: indyCredDefId, schemaId: indySchemaId }
          }
          return undefined
        },
      },
    }
    const credDefName = await parsedCredDefNameFromCredential(credential)
    expect(credDefName).toBe('BankingCredential')
  })

  test('parsedCredDefName forwards ids directly', async () => {
    const indyCredDefId = 'WgWxqztrNooG92RXvxSTWv:3:CL:20:custom'
    const indySchemaId = 'WgWxqztrNooG92RXvxSTWv:2:BankingCredential:1.0'
    const credDefName = await parsedCredDefName(indyCredDefId, indySchemaId)
    expect(credDefName).toBe('custom')
  })
})
